---
title: "MIMOSA Simulations"
format: pdf
editor: visual
---

```{r,message=FALSE,warning=FALSE}
#loading MIMOSA

#install.packages("devtools") #install devtools package
library(devtools) #load it
#install_github("RGLab/MIMOSA",ref="trunk") 
library(ggplot2)
library(MIMOSA) #load MIMOSA
library(dplyr)
```

Parameters

stimulated will react the same whether it is responder or not.Unstimulated reacts different when it is a reponder vs non-responder.

```{r}
set.seed(2025)

# Simulation parameters
n_samples <- c(50,100,200)[3]    # Number of participants
N <- c(10e3,25e3 ,100e3)[1]             # Number of cells measured per sample
w <- c(0.25,0.5,0.75)[2]                # Probability of being a responder
f<-c(1,2,10)[1]#inflation factor
c <- c(1,2,10)[1]                   # Concentration (same for all)
# Concentration and means
mu_u_NR<-0.05
mu_u_R <- 0.01           # Unstim mean for responders 
source("calculated_params.R")
source("get_sim_data.R")
source("prepare_for_mimosa.R")

# Calculate distribution parameters
params <- calculated_params(mu_u_NR, mu_u_R, f, c)

# Generate simulated data
data <- get_sim_data(n_samples, w, params, N)
```

From here we need to format the data so that we can be able to fit MIMOSA

```{r}
# Combine the data
stim_data <- data.frame(
  SUBJECTID = paste0("Subject_", 1:n_samples),
  CYTOKINE = "IL2",
  TCELL = "CD4",
  STIMULATION = "Stimulated",
  CYTNUM = n_s,
  NSUB = N - n_s,
  RefTreat = "Treatment",
  stringsAsFactors = FALSE
)

unstim_data <- data.frame(
  SUBJECTID = paste0("Subject_", 1:n_samples),
  CYTOKINE = "IL2",
  TCELL = "CD4",
  STIMULATION = "Unstimulated",
  CYTNUM = n_u,
  NSUB = N - n_u,
  RefTreat = "Reference",
  stringsAsFactors = FALSE
)

# Combine both into one long-format data frame
sim_data <- rbind(unstim_data, stim_data)
library(dplyr)
E <- prepare_for_mimosa(sim_data)
fit <- MIMOSA(
  NSUB + CYTNUM ~ SUBJECTID | CYTOKINE,
  data = E,
  subset = RefTreat == "Treatment" & CYTOKINE == "IL2",
  ref = RefTreat == "Reference" & CYTOKINE == "IL2",
  RT = FALSE
)
summary(fit)
```