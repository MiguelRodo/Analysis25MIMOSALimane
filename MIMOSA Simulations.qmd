---
title: "MIMOSA script"
format: pdf
editor: visual
---

```{r,message=FALSE,warning=FALSE}
#loading MIMOSA
#install_github("RGLab/MIMOSA",ref="trunk") 
#install.packages("devtools") #install devtools package
library(devtools) 
library(ggplot2)
library(MIMOSA) 
library(dplyr)
library(tidyr)
library(pROC)

#install.packages("pROC", repos = "https://cloud.r-project.org/")
```

```{r}
#Load functions
source("R/calculate_params.R")
source("R/simulate_data.R")
source("R/prepare_for_mimosa.R")
source("R/fit_MIMOSA.R")
source("R/average_ROC_results.R")
source("R/ROC_curve.R")
source("R/fishers_curve.R")
source("R/LRT_curve.R")
source("R/simulate_all.R")
source("R/empirical_density.R")

```

Use parameters from the real world data

```{r}

n_samples_list <- c(200)   # Number of participants
N_list        <- c(10e3)    # Number of cells per sample
w_list       <- c(0.5)      # Probability of responder
f_list       <- c(5)         # Inflation factor

c_stim_list       <- c(85000)     # Concentration
c_unstim_list       <- c(23000)      # Concentration

mu_u_NR <- c(6.467642e-05)          # Means for non-responders (unstimulated)
mu_u_R  <- c(6.467642e-05)          # Means for responders (unstimulated)

n_runs   <- 10             # Number of simulation runs

```

Runs the analysis which - Simulates the data - Fits MIMOSA to the data - Plots the ROC and Fishers Exact test

```{r}
# Run analysis
for (n_samples in n_samples_list) {
  for (N in N_list) {
    for (w in w_list) {
      for (f in f_list) {
        for (c_u in c_unstim_list) {
          for (c_s in c_stim_list) {
            print("=== Running Simulation with Parameters ===")
            print(paste("Parameters: n_samples =", n_samples, ", N =", N, 
                        ", w =", w, ", f =", f, ", c_u =", c_u, ", c_s =", c_s))
            # Store results from multiple runs
            all_roc_mimosa <- list()
            all_roc_fisher <- list()
            # Run multiple simulations
            for (run in 1:n_runs) {
              # Get simulation data
              params <- calculate_params(mu_u_NR, mu_u_R, f, c_u, c_s)
              dat <- simulate_data(n_samples, w, params, N, run)
              #Fit MIMOSA model
              E <- prepare_for_mimosa(dat$data)
              if (is.null(E)) {
                print("E is NULL – skipping this combination")
                next
              }
              print("fitting MIMOSA model")
              fit <- fit_MIMOSA(E)
              #Calculate ROC results
              roc_result <- ROC_curve(fit, dat)
              roc_fisher <- fishers_curve(dat)
              all_roc_mimosa[[run]] <- roc_result
              all_roc_fisher[[run]] <- roc_fisher
            }
            # Average the curves
             avg_roc_mimosa <- average_roc_curves(all_roc_mimosa)
            avg_roc_fisher <- average_roc_curves(all_roc_fisher)
            # Plot averaged curves
             p <- plot_curves(MIMOSA = avg_roc_mimosa, 
                             Fisher = avg_roc_fisher, title = n_samples)
            filename <- sprintf("plots/ROC_avg_ns%d_N%.0f_w%.2f_f%.0f_cu%.0f_cs%.0f_runs%d.png",
                                n_samples, N, w, f, c_u, c_s, n_runs)
            ggsave(filename, plot = p, width = 8, height = 6, dpi = 300)
          }
        }
      }
    }
  }
}

```

Plots the change in cell counts for the responders and non responders. This plot can be used to assessed if realistic data has been generated.

```{r}
for (n_samples in n_samples_list) {
    for (N in N_list) {
        for (w in w_list) {
            for (f in f_list) {
                for (c_u in c_unstim_list) {
                    for (c_s in c_stim_list) {

                    print(paste("Generating plot for: n_samples =", n_samples, 
                               ", N =", N, ", w =", w, ", f =", f, ", c_u =", c_u, ", c_s =", c_s))

                    # Generate data
                    params <- calculate_params(mu_u_NR, mu_u_R, f, c_u, c_s)
                    dat <- simulate_data(n_samples, w, params, N)

                    # Plot the cell count distribution by responder status
                    plot <- plot_responder_comparison(dat)
                    
                    # Save plot
                    filename <- sprintf("plots/cell_counts%d_N%.0f_w%.2f_f%.0f_cu%.0f_cs%.0f.png", 
                                           n_samples, N, w, f, c_u, c_s)

                    ggsave(filename, plot = plot, width = 12, height = 6, dpi = 300)
                    }
            
                }
            }
        }
    }
}

```

Plot the empirical density for unsimulated data

```{r}
empirical_density()
```

Run simulations for varying number of cells

```{r}
#N_list        <- c(10e3, 20e3,50e3)    # Number of cells per sample, 10 and 20k complete
N_list        <- c(50e3)    # Number of cells per sample
n_samples_list <- c(200)   # Number of participants
w_list       <- c(0.5)      # Probability of responder
f_list       <- c(5)         # Inflation factor

c_stim_list       <- c(85000)     # Concentration
c_unstim_list       <- c(23000)      # Concentration

mu_u_NR <- c(6.467642e-05)          # Means for non-responders (unstimulated)
mu_u_R  <- c(6.467642e-05)          # Means for responders (unstimulated)

n_runs   <- 10             # Number of simulation runs
 # Run analysis
for (n_samples in n_samples_list) {
  for (N in N_list) {
    for (w in w_list) {
      for (f in f_list) {
        for (c_u in c_unstim_list) {
          for (c_s in c_stim_list) {
            print("=== Running Simulation with Parameters ===")
            print(paste("Parameters: n_samples =", n_samples, ", N =", N, ", w =", w, ", f =", f, ", c_u =", c_u, ", c_s =", c_s))
            # Store results from multiple runs
            all_roc_mimosa <- list()
            all_roc_fisher <- list()
            # Run multiple simulations
            for (run in 1:n_runs) {
              # Get simulation data
              params <- calculate_params(mu_u_NR, mu_u_R, f, c_u, c_s)
              dat <- simulate_data(n_samples, w, params, N, run)
              #Fit MIMOSA model
                E <- prepare_for_mimosa(dat$data)
              if (is.null(E)) {
                print("E is NULL – skipping this combination")
                next
              }
              print("fitting MIMOSA model")
              fit <- fit_MIMOSA(E)
              #Calculate ROC results
              roc_result <- ROC_curve(fit, dat)
              roc_fisher <- fishers_curve(dat)
                all_roc_mimosa[[run]] <- roc_result
              all_roc_fisher[[run]] <- roc_fisher
            }
            # Average the curves
             avg_roc_mimosa <- average_roc_curves(all_roc_mimosa)
            avg_roc_fisher <- average_roc_curves(all_roc_fisher)
            # Plot averaged curves
             p <- plot_curves(MIMOSA = avg_roc_mimosa, 
                             Fisher = avg_roc_fisher, title = n_samples)
            filename <- sprintf("plots/ROC_avg_ns%d_N%.0f_w%.2f_f%.0f_cu%.0f_cs%.0f_runs%d.png",
                                n_samples, N, w, f, c_u, c_s, n_runs)
              ggsave(filename, plot = p, width = 8, height = 6, dpi = 300)
          }
        }
      }
    }
  }
}
```

Run simulations for varying number of subjects

```{r}
n_samples_list <- c(20, 50, 100)   # Number of participants

N_list        <- c(10e3)    # Number of cells per sample
w_list       <- c(0.5)      # Probability of responder
f_list       <- c(5)         # Inflation factor

c_stim_list       <- c(85000)     # Concentration
c_unstim_list       <- c(23000)      # Concentration

mu_u_NR <- c(6.467642e-05)          # Means for non-responders (unstimulated)
mu_u_R  <- c(6.467642e-05)          # Means for responders (unstimulated)

n_runs   <- 10             # Number of simulation runs

  # Run analysis
for (n_samples in n_samples_list) {
  for (N in N_list) {
    for (w in w_list) {
      for (f in f_list) {
        for (c_u in c_unstim_list) {
          for (c_s in c_stim_list) {
            print("=== Running Simulation with Parameters ===")
            print(paste("Parameters: n_samples =", n_samples, ", N =", N, ", w =", w, ", f =", f, ", c_u =", c_u, ", c_s =", c_s))
            # Store results from multiple runs
            all_roc_mimosa <- list()
            all_roc_fisher <- list()
            # Run multiple simulations
            for (run in 1:n_runs) {
              # Get simulation data
              params <- calculate_params(mu_u_NR, mu_u_R, f, c_u, c_s)
              dat <- simulate_data(n_samples, w, params, N, run)
              #Fit MIMOSA model
                E <- prepare_for_mimosa(dat$data)
              if (is.null(E)) {
                print("E is NULL – skipping this combination")
                next
              }
              print("fitting MIMOSA model")
              fit <- fit_MIMOSA(E)
              #Calculate ROC results
              roc_result <- ROC_curve(fit, dat)
              roc_fisher <- fishers_curve(dat)
                all_roc_mimosa[[run]] <- roc_result
              all_roc_fisher[[run]] <- roc_fisher
            }
            # Average the curves
             avg_roc_mimosa <- average_roc_curves(all_roc_mimosa)
            avg_roc_fisher <- average_roc_curves(all_roc_fisher)
            # Plot averaged curves
             p <- plot_curves(MIMOSA = avg_roc_mimosa, 
                             Fisher = avg_roc_fisher, title = n_samples)
            filename <- sprintf("plots/ROC_avg_ns%d_N%.0f_w%.2f_f%.0f_cu%.0f_cs%.0f_runs%d.png",
                                n_samples, N, w, f, c_u, c_s, n_runs)
              ggsave(filename, plot = p, width = 8, height = 6, dpi = 300)
          }
        }
      }
    }
  }
}
```

Varying the proportion of responders

```{r}
#w_list <- c(0.2, 0.4, 0.6,0.8)
w_list <- c(0.8 , 1)
n_samples_list <- c(200)   # Number of participants
N_list        <- c(10e3)    # Number of cells per sample

f_list       <- c(5)         # Inflation factor

c_stim_list       <- c(85000)     # Concentration
c_unstim_list       <- c(23000)      # Concentration

mu_u_NR <- c(6.467642e-05)          # Means for non-responders (unstimulated)
mu_u_R  <- c(6.467642e-05)          # Means for responders (unstimulated)

n_runs   <- 10             # Number of simulation runs

# Run analysis
for (n_samples in n_samples_list) {
  for (N in N_list) {
    for (w in w_list) {
      for (f in f_list) {
        for (c_u in c_unstim_list) {
          for (c_s in c_stim_list) {
            print("=== Running Simulation with Parameters ===")
            print(paste("Parameters: n_samples =", n_samples, ", N =", N, ", w =", w, ", f =", f, ", c_u =", c_u, ", c_s =", c_s))
            # Store results from multiple runs
            all_roc_mimosa <- list()
            all_roc_fisher <- list()
            # Run multiple simulations
            for (run in 1:n_runs) {
              # Get simulation data
              params <- calculate_params(mu_u_NR, mu_u_R, f, c_u, c_s)
              dat <- simulate_data(n_samples, w, params, N, run)
              #Fit MIMOSA model
                E <- prepare_for_mimosa(dat$data)
              if (is.null(E)) {
                print("E is NULL – skipping this combination")
                next
              }
              print("fitting MIMOSA model")
              fit <- fit_MIMOSA(E)
              #Calculate ROC results
              roc_result <- ROC_curve(fit, dat)
              roc_fisher <- fishers_curve(dat)
                all_roc_mimosa[[run]] <- roc_result
              all_roc_fisher[[run]] <- roc_fisher
            }
            # Average the curves
             avg_roc_mimosa <- average_roc_curves(all_roc_mimosa)
            avg_roc_fisher <- average_roc_curves(all_roc_fisher)
            # Plot averaged curves
             p <- plot_curves(MIMOSA = avg_roc_mimosa, 
                             Fisher = avg_roc_fisher, title = n_samples)
            filename <- sprintf("plots/ROC_avg_ns%d_N%.0f_w%.2f_f%.0f_cu%.0f_cs%.0f_runs%d.png",
                                n_samples, N, w, f, c_u, c_s, n_runs)
              ggsave(filename, plot = p, width = 8, height = 6, dpi = 300)
          }
        }
      }
    }
  }
}
```